syntax = "proto3";

option java_multiple_files = true;
option java_package = "io.grpc.ai";

import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/any.proto";


// A bidirectional streaming API for real-time inference over sequences (e.g. video frames).

// ========== Common, self-contained definitions (no dependency on ai.proto) ==========

message TraceContext {
  string trace_id = 1;
  string span_id = 2;
  string parent_span_id = 3;
}

message TenantContext {
  string tenant_id = 1;
  string user_id = 2;
  map<string, string> attrs = 3;
}

message CustomStatus {
  int32 code = 1;
  string message = 2;
  repeated google.protobuf.Any details = 3;
}

message ModelSpec {
  string name = 1;
  string version = 2;
  map<string, string> tags = 3;
}

message InferenceHeader {
  ModelSpec model = 1;
  TraceContext trace = 2;
  TenantContext tenant = 3;
  google.protobuf.Struct options = 4;
  repeated string accept = 5;
}

message InputEnvelope {
  string kind = 1;           // e.g. "image", "text"
  string content_type = 2;   // e.g. "image/jpeg"
  oneof payload {
    google.protobuf.Any message = 10;
    string text = 11;
    bytes binary = 12;
    google.protobuf.Struct json = 13;
  }
  map<string, string> tags = 20;
}

message ResultEnvelope {
  string kind = 1;           // e.g. "detections", "overlay"
  string content_type = 2;   // e.g. 'application/x-protobuf;type="google.protobuf.Struct"'
  oneof result {
    google.protobuf.Any message = 10;
    string text = 11;
    bytes binary = 12;
    google.protobuf.Struct json = 13;
  }
  google.protobuf.Struct meta = 20;
  int32 input_index = 30;
}

// Client-to-server stream messages
message StreamOpen {
  InferenceHeader header = 1; // initial options; same semantics as unary
}

message StreamFrame {
  // one frame or chunk; typically a single image input with kind="image"
  repeated InputEnvelope inputs = 1;
  int64 frame_index = 2;       // sequential index starting at 0
  google.protobuf.Timestamp ts = 3; // optional send/shot time
}

message StreamClose {
  // optional reason/metadata
  google.protobuf.Struct meta = 1;
}

message StreamRequest {
  oneof event {
    StreamOpen open = 1;
    StreamFrame frame = 2;
    StreamClose close = 3;
  }
}

// Server-to-client stream messages
message StreamAck {
  // ack for open/close or generic signal
  CustomStatus status = 1;
}

message FrameResult {
  int64 frame_index = 1;
  repeated ResultEnvelope results = 2; // reuse detections/overlay envelopes
  google.protobuf.Struct meta = 3;     // e.g., runtime_ms
}

message StreamResponse {
  oneof event {
    StreamAck ack = 1;         // open/close acks or heartbeat
    FrameResult frame = 2;     // results for a submitted frame
  }
}

service InferenceStreamService {
  rpc Stream (stream StreamRequest) returns (stream StreamResponse);
}


